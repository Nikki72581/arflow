// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  CUSTOMER
}

enum PlanTier {
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum DocumentType {
  INVOICE
  CREDIT_MEMO
  DEBIT_MEMO
}

enum DocumentStatus {
  OPEN
  PARTIAL
  PAID
  VOID
}

enum PaymentStatus {
  PENDING
  APPLIED
  VOID
}

enum PaymentMethod {
  CHECK
  WIRE
  ACH
  CREDIT_CARD
  OTHER
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  ON_HOLD
  COLLECTIONS
}

enum RecordSourceType {
  MANUAL
  INTEGRATION
  CSV_IMPORT
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum SyncFrequency {
  MANUAL
  HOURLY
  DAILY
  WEEKLY
}

enum BranchFilterMode {
  ALL
  SELECTED
}

enum CustomerHandling {
  AUTO_CREATE
  SKIP
}

enum CustomerIdSource {
  CUSTOMER_CD // Visual ID like "CUST001"
  BACCOUNT_ID // Internal database ID
}

enum DataSourceType {
  REST_API // Standard Invoice/SalesInvoice/SalesOrder entities
  GENERIC_INQUIRY // Custom Generic Inquiry via OData
  DAC_ODATA // Direct DAC access (advanced)
}

enum UnmappedAction {
  SKIP // Don't import records without mapped customer
  DEFAULT_USER // Assign to defaultCustomerUserId
}

enum CustomerMappingStatus {
  PENDING // Needs action from admin
  MATCHED // Successfully mapped to a user
  PLACEHOLDER // Will create placeholder user on sync
  IGNORED // Admin chose to skip this customer
}

enum CustomerMatchType {
  AUTO_EMAIL // Matched automatically by email
  AUTO_NAME // Matched automatically by name
  AUTO_PLACEHOLDER // Will auto-create placeholder user
  MANUAL // Manually selected by admin
  CREATED_NEW // Admin created a new user for this customer
}

enum SyncType {
  MANUAL
  SCHEDULED
}

enum SyncStatus {
  STARTED
  IN_PROGRESS
  SUCCESS
  PARTIAL_SUCCESS
  FAILED
}

// ============================================
// CORE MODELS
// ============================================

model Organization {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  clerkOrgId String?  @unique // Clerk organization ID for team invitations
  planTier   PlanTier @default(STARTER)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users                User[]
  customers            Customer[]
  arDocuments          ArDocument[]
  payments             CustomerPayment[]
  paymentApplications  PaymentApplication[]
  auditLogs            AuditLog[]
  acumaticaIntegration AcumaticaIntegration?

  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  clerkId        String?  @unique // Nullable for placeholder users not yet invited
  email          String
  firstName      String?
  lastName       String?
  role           UserRole @default(CUSTOMER)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Placeholder user tracking
  isPlaceholder Boolean   @default(false) // True if user created without Clerk invite
  invitedAt     DateTime? // When Clerk invitation was sent (null for placeholders)

  // Customer-specific fields (when role = CUSTOMER)
  customerId String? @unique // Reference to Customer record if this is a customer portal user

  // Notification preferences
  emailNotifications Boolean @default(true)
  invoiceAlerts      Boolean @default(true)
  paymentAlerts      Boolean @default(true)
  statementAlerts    Boolean @default(false)

  // Theme preference
  themePreference String @default("system") // "light" | "dark" | "system"

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer?    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  auditLogs    AuditLog[]

  @@index([organizationId])
  @@index([clerkId])
  @@index([email, organizationId])
  @@index([isPlaceholder])
  @@index([customerId])
  @@map("users")
}

model Customer {
  id             String         @id @default(cuid())
  customerNumber String? // External customer number/code
  companyName    String
  contactName    String?
  email          String?
  phone          String?
  website        String?
  organizationId String

  // Address fields
  billingAddress1 String?
  billingAddress2 String?
  billingCity     String?
  billingState    String?
  billingZip      String?
  billingCountry  String?

  shippingAddress1 String?
  shippingAddress2 String?
  shippingCity     String?
  shippingState    String?
  shippingZip      String?
  shippingCountry  String?

  // AR Management fields
  creditLimit     Float?         @default(0)
  currentBalance  Float          @default(0) // Calculated field, updated on document/payment changes
  status          CustomerStatus @default(ACTIVE)
  paymentTerms    String? // e.g., "Net 30", "Net 60"
  notes           String?

  // Portal Access
  portalEnabled Boolean   @default(false)
  lastLoginAt   DateTime?

  // Integration Source Tracking
  externalId             String? // CustomerCD from Acumatica
  externalSystem         String? // "ACUMATICA" or null for manual
  sourceType             RecordSourceType @default(MANUAL)
  createdByIntegrationId String?
  createdBySyncLogId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  arDocuments  ArDocument[]
  payments     CustomerPayment[]
  portalUsers  User[] // Portal users linked to this customer

  @@unique([organizationId, externalId, externalSystem])
  @@index([organizationId])
  @@index([status])
  @@index([customerNumber])
  @@map("customers")
}

// ============================================
// AR DOCUMENT MODELS
// ============================================

model ArDocument {
  id             String         @id @default(cuid())
  organizationId String
  customerId     String
  documentType   DocumentType
  documentNumber String // Invoice number, CM number, etc.
  referenceNumber String? // PO number, reference, etc.

  // Dates
  documentDate DateTime
  dueDate      DateTime?
  paidDate     DateTime? // When fully paid

  // Amounts
  subtotal    Float
  taxAmount   Float  @default(0)
  totalAmount Float
  amountPaid  Float  @default(0)
  balanceDue  Float // totalAmount - amountPaid

  // Status
  status DocumentStatus @default(OPEN)

  // Description and notes
  description   String? // Line item description or summary
  notes         String? // Internal notes
  customerNotes String? // Notes visible to customer on portal

  // Integration Source Tracking
  sourceType     RecordSourceType @default(MANUAL)
  externalSystem String? // "ACUMATICA" or null
  externalId     String? // RefNbr from external system
  integrationId  String?
  syncLogId      String?

  // Acumatica Reference Data
  externalInvoiceRef  String? // Invoice RefNbr
  externalBranch      String?
  externalLineNumber  Int?
  externalItemId      String?
  externalDescription String?

  // Raw data for debugging
  rawExternalData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer            Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentApplications PaymentApplication[]

  @@unique([organizationId, externalId, externalSystem])
  @@index([organizationId])
  @@index([customerId])
  @@index([documentType])
  @@index([status])
  @@index([documentDate])
  @@index([dueDate])
  @@map("ar_documents")
}

// ============================================
// PAYMENT MODELS
// ============================================

model CustomerPayment {
  id             String        @id @default(cuid())
  organizationId String
  customerId     String
  paymentNumber  String // Payment reference number
  paymentDate    DateTime
  amount         Float
  paymentMethod  PaymentMethod @default(CHECK)
  referenceNumber String? // Check number, wire confirmation, etc.
  status         PaymentStatus @default(APPLIED)
  notes          String?

  // Integration tracking
  sourceType     RecordSourceType @default(MANUAL)
  externalSystem String?
  externalId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer            Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentApplications PaymentApplication[]

  @@index([organizationId])
  @@index([customerId])
  @@index([paymentDate])
  @@index([status])
  @@map("customer_payments")
}

model PaymentApplication {
  id           String   @id @default(cuid())
  paymentId    String
  arDocumentId String
  amountApplied Float
  createdAt    DateTime @default(now())

  organizationId String

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payment      CustomerPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  arDocument   ArDocument      @relation(fields: [arDocumentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([arDocumentId])
  @@index([organizationId])
  @@map("payment_applications")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Who performed the action
  userId    String?
  userName  String? // Cached for display
  userEmail String? // Cached for display

  // What action was performed
  action     String // e.g. "invoice_created", "payment_applied", "customer_updated"
  entityType String // e.g. "invoice", "payment", "customer"
  entityId   String? // ID of the entity affected

  // Details
  description String // Human-readable description
  metadata    Json? // Additional structured data

  // Context
  organizationId String
  ipAddress      String?
  userAgent      String?

  // Relations
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// INTEGRATION MODELS
// ============================================

model AcumaticaIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // Connection Settings
  instanceUrl            String // e.g., "https://company.acumatica.com"
  apiVersion             String // e.g., "24.200.001"
  companyId              String // Acumatica tenant/company
  encryptedCredentials   String // Encrypted JSON with username/password or OAuth tokens
  status                 IntegrationStatus @default(INACTIVE)
  lastConnectionTest     DateTime?
  connectionErrorMessage String?

  // Data Source Configuration
  dataSourceType     DataSourceType @default(REST_API)
  dataSourceEntity   String         @default("Invoice") // e.g., "Invoice", "SalesInvoice", or GI name
  dataSourceEndpoint String? // Full endpoint URL for queries

  // Discovered Schema (cached)
  discoveredSchema  Json? // Cached field schema from Acumatica
  schemaLastUpdated DateTime?

  // Dynamic Field Mappings
  fieldMappings Json? // Field mapping configuration

  // Dynamic Filter Configuration
  filterConfig Json? // Filter configuration

  // Unmapped Customer Handling
  unmappedCustomerAction UnmappedAction @default(SKIP)
  defaultCustomerUserId  String?

  // Sync Schedule
  syncFrequency     SyncFrequency @default(MANUAL)
  syncTime          String? // e.g., "02:00" for daily sync time
  syncDayOfWeek     Int? // 0-6 for weekly sync (0 = Sunday)
  lastSyncAt        DateTime?
  nextScheduledSync DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerMappings  AcumaticaCustomerMapping[]
  syncLogs          IntegrationSyncLog[]

  @@index([organizationId])
  @@map("acumatica_integrations")
}

model AcumaticaCustomerMapping {
  id            String @id @default(cuid())
  integrationId String

  // Acumatica Data
  acumaticaCustomerId   String // Customer CD from Acumatica
  acumaticaCustomerName String
  acumaticaEmail        String?

  // Mapping Status
  status    CustomerMappingStatus @default(PENDING)
  matchType CustomerMatchType?

  // ARFlow Customer (nullable until mapped)
  customerId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  integration AcumaticaIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, acumaticaCustomerId])
  @@index([integrationId])
  @@index([customerId])
  @@map("acumatica_customer_mappings")
}

model IntegrationSyncLog {
  id            String @id @default(cuid())
  integrationId String

  // Sync Metadata
  syncType      SyncType
  status        SyncStatus @default(STARTED)
  startedAt     DateTime   @default(now())
  completedAt   DateTime?
  triggeredById String? // User ID if manual, null if scheduled

  // Counters
  invoicesFetched    Int @default(0)
  invoicesProcessed  Int @default(0)
  invoicesSkipped    Int @default(0)
  documentsCreated   Int @default(0)
  customersCreated   Int @default(0)
  errorsCount        Int @default(0)

  // Detailed Results
  skipDetails    Json? // Array of {invoiceRef, reason}
  errorDetails   Json? // Array of {invoiceRef, error}
  createdRecords Json? // Summary of created customers/documents

  // Timestamps
  createdAt DateTime  @default(now())
  undoneAt  DateTime? // Timestamp when sync was undone

  integration AcumaticaIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([startedAt])
  @@map("integration_sync_logs")
}
