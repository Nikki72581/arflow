// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  CUSTOMER
}

enum PlanTier {
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum DocumentType {
  INVOICE
  QUOTE
  ORDER
  CREDIT_MEMO
  DEBIT_MEMO
}

enum DocumentStatus {
  OPEN
  PARTIAL
  PAID
  VOID
}

enum PaymentStatus {
  PENDING
  APPLIED
  VOID
}

enum PaymentMethod {
  CHECK
  WIRE
  ACH
  CREDIT_CARD
  OTHER
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  ON_HOLD
  COLLECTIONS
}

enum RecordSourceType {
  MANUAL
  INTEGRATION
  CSV_IMPORT
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum SyncFrequency {
  MANUAL
  HOURLY
  DAILY
  WEEKLY
}

enum BranchFilterMode {
  ALL
  SELECTED
}

enum CustomerHandling {
  AUTO_CREATE
  SKIP
}

enum CustomerIdSource {
  CUSTOMER_CD // Visual ID like "CUST001"
  BACCOUNT_ID // Internal database ID
}

enum DataSourceType {
  REST_API // Standard Invoice/SalesInvoice/SalesOrder entities
  GENERIC_INQUIRY // Custom Generic Inquiry via OData
  DAC_ODATA // Direct DAC access (advanced)
}

enum UnmappedAction {
  SKIP // Don't import records without mapped customer
  DEFAULT_USER // Assign to defaultCustomerUserId
}

enum CustomerMappingStatus {
  PENDING // Needs action from admin
  MATCHED // Successfully mapped to a user
  PLACEHOLDER // Will create placeholder user on sync
  IGNORED // Admin chose to skip this customer
}

enum CustomerMatchType {
  AUTO_EMAIL // Matched automatically by email
  AUTO_NAME // Matched automatically by name
  AUTO_PLACEHOLDER // Will auto-create placeholder user
  MANUAL // Manually selected by admin
  CREATED_NEW // Admin created a new user for this customer
}

enum SyncType {
  MANUAL
  SCHEDULED
}

enum SyncStatus {
  STARTED
  IN_PROGRESS
  SUCCESS
  PARTIAL_SUCCESS
  FAILED
}

enum PaymentGatewayProvider {
  AUTHORIZE_NET
  STRIPE
}

// ============================================
// CORE MODELS
// ============================================

model Organization {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  clerkOrgId String?  @unique // Clerk organization ID for team invitations
  planTier   PlanTier @default(STARTER)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users                   User[]
  customers               Customer[]
  arDocuments             ArDocument[]
  payments                CustomerPayment[]
  paymentApplications     PaymentApplication[]
  auditLogs               AuditLog[]
  acumaticaIntegration    AcumaticaIntegration?
  authorizeNetIntegration AuthorizeNetIntegration?
  stripeIntegration       StripeIntegration?
  paymentGatewaySettings  PaymentGatewaySettings?
  documentTypeSettings    DocumentTypeSetting[]
  paymentTermTypes        PaymentTermType[]

  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  clerkId        String?  @unique // Nullable for placeholder users not yet invited
  email          String
  firstName      String?
  lastName       String?
  role           UserRole @default(CUSTOMER)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Placeholder user tracking
  isPlaceholder Boolean   @default(false) // True if user created without Clerk invite
  invitedAt     DateTime? // When Clerk invitation was sent (null for placeholders)

  // Customer-specific fields (when role = CUSTOMER)
  customerId String? @unique // Reference to Customer record if this is a customer portal user

  // Notification preferences
  emailNotifications Boolean @default(true)
  invoiceAlerts      Boolean @default(true)
  paymentAlerts      Boolean @default(true)
  statementAlerts    Boolean @default(false)

  // Theme preference
  themePreference String @default("system") // "light" | "dark" | "system"

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer?    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  auditLogs    AuditLog[]

  @@index([organizationId])
  @@index([clerkId])
  @@index([email, organizationId])
  @@index([isPlaceholder])
  @@index([customerId])
  @@map("users")
}

model Customer {
  id             String         @id @default(cuid())
  customerNumber String? // External customer number/code
  companyName    String
  contactName    String?
  email          String?
  phone          String?
  website        String?
  organizationId String

  // Address fields
  billingAddress1 String?
  billingAddress2 String?
  billingCity     String?
  billingState    String?
  billingZip      String?
  billingCountry  String?

  shippingAddress1 String?
  shippingAddress2 String?
  shippingCity     String?
  shippingState    String?
  shippingZip      String?
  shippingCountry  String?

  // AR Management fields
  creditLimit     Float?         @default(0)
  currentBalance  Float          @default(0) // Calculated field, updated on document/payment changes
  status          CustomerStatus @default(ACTIVE)
  paymentTerms    String? @map("payment_terms_legacy") // Deprecated: legacy payment terms text
  paymentTermId   String? // Foreign key to PaymentTermType
  notes           String?

  // Portal Access
  portalEnabled Boolean   @default(false)
  lastLoginAt   DateTime?

  // Integration Source Tracking
  externalId             String? // CustomerCD from Acumatica
  externalSystem         String? // "ACUMATICA" or null for manual
  sourceType             RecordSourceType @default(MANUAL)
  createdByIntegrationId String?
  createdBySyncLogId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  paymentTerm  PaymentTermType? @relation(fields: [paymentTermId], references: [id], onDelete: SetNull)
  arDocuments  ArDocument[]
  payments     CustomerPayment[]
  portalUsers  User[] // Portal users linked to this customer

  @@unique([organizationId, externalId, externalSystem])
  @@index([organizationId])
  @@index([status])
  @@index([customerNumber])
  @@index([paymentTermId])
  @@map("customers")
}

// ============================================
// AR DOCUMENT MODELS
// ============================================

model ArDocument {
  id             String         @id @default(cuid())
  organizationId String
  customerId     String
  documentType   DocumentType
  documentNumber String // Invoice number, CM number, etc.
  referenceNumber String? // PO number, reference, etc.

  // Dates
  documentDate DateTime
  dueDate      DateTime?
  paidDate     DateTime? // When fully paid

  // Amounts
  subtotal    Float
  taxAmount   Float  @default(0)
  totalAmount Float
  amountPaid  Float  @default(0)
  balanceDue  Float // totalAmount - amountPaid

  // Status
  status DocumentStatus @default(OPEN)

  // Description and notes
  description   String? // Line item description or summary
  notes         String? // Internal notes
  customerNotes String? // Notes visible to customer on portal

  // Payment Term Tracking
  paymentTermId        String? // Reference to payment term at creation
  appliedPaymentTerm   Json? // Snapshot: {name, daysDue, discountDays, discountPercentage}
  earlyPaymentDeadline DateTime? // Date by which discount applies
  discountPercentage   Float? // Discount percentage if paid early
  discountAvailable    Float? // Dollar amount of discount available
  discountTaken        Float    @default(0) // Discount actually applied

  // Payment Schedule
  hasPaymentSchedule Boolean @default(false)

  // Integration Source Tracking
  sourceType     RecordSourceType @default(MANUAL)
  externalSystem String? // "ACUMATICA" or null
  externalId     String? // RefNbr from external system
  integrationId  String?
  syncLogId      String?

  // Acumatica Reference Data
  externalInvoiceRef  String? // Invoice RefNbr
  externalBranch      String?
  externalLineNumber  Int?
  externalItemId      String?
  externalDescription String?

  // Raw data for debugging
  rawExternalData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization        Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer            Customer                     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentApplications PaymentApplication[]
  paymentSchedule     PaymentScheduleInstallment[]

  @@unique([organizationId, externalId, externalSystem])
  @@index([organizationId])
  @@index([customerId])
  @@index([documentType])
  @@index([status])
  @@index([documentDate])
  @@index([dueDate])
  @@map("ar_documents")
}

model DocumentTypeSetting {
  id             String       @id @default(cuid())
  organizationId String
  documentType   DocumentType
  enabled        Boolean      @default(true)
  displayName    String // Customizable display name (e.g., "Quote" -> "Estimate")
  displayOrder   Int          @default(0) // Order for tabs display
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, documentType])
  @@index([organizationId])
  @@index([enabled])
  @@map("document_type_settings")
}

model PaymentTermType {
  id             String   @id @default(cuid())
  organizationId String

  // Display information
  name        String // e.g., "2% 10 Net 30", "Net 15", "Net 30"
  description String? // Optional detailed explanation
  code        String // Short code: "2_10_NET_30", "NET_15"

  // Term configuration
  daysDue Int // Number of days until due (e.g., 30)

  // Early payment discount (optional)
  hasDiscount        Boolean @default(false)
  discountDays       Int? // Days within which discount applies (e.g., 10)
  discountPercentage Float? // Discount percentage (e.g., 2.0 for 2%)

  // Settings
  enabled      Boolean @default(true)
  displayOrder Int     @default(0)
  isDefault    Boolean @default(false) // One default per organization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customers    Customer[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([enabled])
  @@map("payment_term_types")
}

model PaymentScheduleInstallment {
  id           String   @id @default(cuid())
  arDocumentId String

  // Installment details
  installmentNumber Int // 1, 2, 3, etc.
  dueDate           DateTime
  amount            Float
  description       String? // e.g., "First installment", "Final payment"

  // Payment tracking
  status     DocumentStatus @default(OPEN) // OPEN, PARTIAL, PAID, VOID
  amountPaid Float          @default(0)
  balanceDue Float // amount - amountPaid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  arDocument ArDocument @relation(fields: [arDocumentId], references: [id], onDelete: Cascade)

  @@index([arDocumentId])
  @@index([dueDate])
  @@index([status])
  @@map("payment_schedule_installments")
}

// ============================================
// PAYMENT MODELS
// ============================================

model CustomerPayment {
  id             String        @id @default(cuid())
  organizationId String
  customerId     String
  paymentNumber  String // Payment reference number
  paymentDate    DateTime
  amount         Float
  paymentMethod  PaymentMethod @default(CHECK)
  referenceNumber String? // Check number, wire confirmation, etc.
  status         PaymentStatus @default(APPLIED)
  notes          String?

  // Payment Gateway Integration (Authorize.net, Stripe, etc.)
  gatewayTransactionId   String? // Transaction ID from payment gateway
  gatewayResponse        Json? // Full gateway response for debugging
  last4Digits            String? // Last 4 digits of card (for display)
  cardType               String? // Visa, Mastercard, Amex, etc.
  paymentGatewayProvider PaymentGatewayProvider? // Which gateway processed this payment

  // Integration tracking
  sourceType     RecordSourceType @default(MANUAL)
  externalSystem String?
  externalId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer            Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentApplications PaymentApplication[]

  @@index([organizationId])
  @@index([customerId])
  @@index([paymentDate])
  @@index([status])
  @@index([gatewayTransactionId])
  @@map("customer_payments")
}

model PaymentApplication {
  id           String   @id @default(cuid())
  paymentId    String
  arDocumentId String
  amountApplied Float
  createdAt    DateTime @default(now())

  organizationId String

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payment      CustomerPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  arDocument   ArDocument      @relation(fields: [arDocumentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([arDocumentId])
  @@index([organizationId])
  @@map("payment_applications")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Who performed the action
  userId    String?
  userName  String? // Cached for display
  userEmail String? // Cached for display

  // What action was performed
  action     String // e.g. "invoice_created", "payment_applied", "customer_updated"
  entityType String // e.g. "invoice", "payment", "customer"
  entityId   String? // ID of the entity affected

  // Details
  description String // Human-readable description
  metadata    Json? // Additional structured data

  // Context
  organizationId String
  ipAddress      String?
  userAgent      String?

  // Relations
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// INTEGRATION MODELS
// ============================================

model AcumaticaIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // Connection Settings
  instanceUrl            String // e.g., "https://company.acumatica.com"
  apiVersion             String // e.g., "24.200.001"
  companyId              String // Acumatica tenant/company
  encryptedCredentials   String // Encrypted JSON with username/password or OAuth tokens
  status                 IntegrationStatus @default(INACTIVE)
  lastConnectionTest     DateTime?
  connectionErrorMessage String?

  // Data Source Configuration
  dataSourceType     DataSourceType @default(REST_API)
  dataSourceEntity   String         @default("Invoice") // e.g., "Invoice", "SalesInvoice", or GI name
  dataSourceEndpoint String? // Full endpoint URL for queries

  // Discovered Schema (cached)
  discoveredSchema  Json? // Cached field schema from Acumatica
  schemaLastUpdated DateTime?

  // Dynamic Field Mappings
  fieldMappings Json? // Field mapping configuration

  // Dynamic Filter Configuration
  filterConfig Json? // Filter configuration

  // Unmapped Customer Handling
  unmappedCustomerAction UnmappedAction @default(SKIP)
  defaultCustomerUserId  String?

  // Sync Schedule
  syncFrequency     SyncFrequency @default(MANUAL)
  syncTime          String? // e.g., "02:00" for daily sync time
  syncDayOfWeek     Int? // 0-6 for weekly sync (0 = Sunday)
  lastSyncAt        DateTime?
  nextScheduledSync DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerMappings  AcumaticaCustomerMapping[]
  syncLogs          IntegrationSyncLog[]

  @@index([organizationId])
  @@map("acumatica_integrations")
}

model AcumaticaCustomerMapping {
  id            String @id @default(cuid())
  integrationId String

  // Acumatica Data
  acumaticaCustomerId   String // Customer CD from Acumatica
  acumaticaCustomerName String
  acumaticaEmail        String?

  // Mapping Status
  status    CustomerMappingStatus @default(PENDING)
  matchType CustomerMatchType?

  // ARFlow Customer (nullable until mapped)
  customerId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  integration AcumaticaIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, acumaticaCustomerId])
  @@index([integrationId])
  @@index([customerId])
  @@map("acumatica_customer_mappings")
}

model IntegrationSyncLog {
  id            String @id @default(cuid())
  integrationId String

  // Sync Metadata
  syncType      SyncType
  status        SyncStatus @default(STARTED)
  startedAt     DateTime   @default(now())
  completedAt   DateTime?
  triggeredById String? // User ID if manual, null if scheduled

  // Counters
  invoicesFetched    Int @default(0)
  invoicesProcessed  Int @default(0)
  invoicesSkipped    Int @default(0)
  documentsCreated   Int @default(0)
  customersCreated   Int @default(0)
  errorsCount        Int @default(0)

  // Detailed Results
  skipDetails    Json? // Array of {invoiceRef, reason}
  errorDetails   Json? // Array of {invoiceRef, error}
  createdRecords Json? // Summary of created customers/documents

  // Timestamps
  createdAt DateTime  @default(now())
  undoneAt  DateTime? // Timestamp when sync was undone

  integration AcumaticaIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([startedAt])
  @@map("integration_sync_logs")
}

// ============================================
// PAYMENT GATEWAY INTEGRATIONS
// ============================================

model AuthorizeNetIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // API Credentials
  apiLoginId           String // API Login ID from Authorize.net
  encryptedTransactionKey String // Encrypted Transaction Key

  // Environment
  isProduction Boolean @default(false) // false = sandbox, true = production

  // Settings
  enabled              Boolean @default(false)
  lastConnectionTest   DateTime?
  connectionErrorMessage String?

  // Features
  enableCustomerPayments Boolean @default(true) // Allow customer portal payments
  enablePaymentLinks    Boolean @default(false) // Future: One-time payment links
  enableTerminals       Boolean @default(false) // Future: Hardware terminal support

  // Transaction Settings
  requireCVV           Boolean @default(true)
  requireBillingAddress Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("authorize_net_integrations")
}

model StripeIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // API Credentials (encrypted)
  encryptedSecretKey      String // Encrypted Secret Key (sk_test_... or sk_live_...)
  encryptedPublishableKey String // Encrypted Publishable Key (pk_test_... or pk_live_...)
  encryptedWebhookSecret  String? // Optional: Encrypted webhook signing secret

  // Environment
  isProduction Boolean @default(false) // false = test mode, true = live mode

  // Settings
  enabled                Boolean   @default(false)
  lastConnectionTest     DateTime?
  connectionErrorMessage String?

  // Features
  enableCustomerPayments Boolean @default(true) // Allow customer portal payments
  enablePaymentLinks     Boolean @default(false) // Future: Payment Links
  enableSavedCards       Boolean @default(false) // Future: Save cards for future use

  // Transaction Settings
  requireCVV            Boolean @default(true)
  requireBillingAddress Boolean @default(true)
  captureMethod         String  @default("automatic") // "automatic" or "manual"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("stripe_integrations")
}

model PaymentGatewaySettings {
  id             String                   @id @default(cuid())
  organizationId String                   @unique
  activeProvider PaymentGatewayProvider? // null = no active provider

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("payment_gateway_settings")
}
